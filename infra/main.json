{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.40.2.10011",
      "templateHash": "15569691290546012591"
    }
  },
  "parameters": {
    "environment": {
      "type": "string",
      "defaultValue": "prod",
      "allowedValues": [
        "dev",
        "staging",
        "prod"
      ],
      "metadata": {
        "description": "Environment name (dev, staging, prod)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "global",
      "metadata": {
        "description": "Azure region for Front Door (global service)"
      }
    },
    "enableWaf": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable WAF policy"
      }
    },
    "skuName": {
      "type": "string",
      "defaultValue": "Premium_AzureFrontDoor",
      "allowedValues": [
        "Standard_AzureFrontDoor",
        "Premium_AzureFrontDoor"
      ],
      "metadata": {
        "description": "Front Door SKU - Premium includes WAF managed rules (OWASP, Bot Manager)"
      }
    },
    "staticWebAppHostname": {
      "type": "string",
      "metadata": {
        "description": "Static Web App hostname (no https:// prefix)"
      }
    },
    "orchestratorApiHostname": {
      "type": "string",
      "metadata": {
        "description": "Orchestrator API Container App hostname (no https:// prefix) - serves /api/* endpoints (picks, archive, scoreboard proxy, etc.)"
      }
    },
    "nbaApiHostname": {
      "type": "string",
      "metadata": {
        "description": "NBA API Container App hostname (no https:// prefix)"
      }
    },
    "ncaamApiHostname": {
      "type": "string",
      "metadata": {
        "description": "NCAAM API Container App hostname (no https:// prefix)"
      }
    },
    "nflApiHostname": {
      "type": "string",
      "metadata": {
        "description": "NFL API Container App hostname (no https:// prefix)"
      }
    },
    "ncaafApiHostname": {
      "type": "string",
      "metadata": {
        "description": "NCAAF API Container App hostname (no https:// prefix)"
      }
    },
    "customDomainName": {
      "type": "string",
      "defaultValue": "www.greenbiersportventures.com",
      "metadata": {
        "description": "Custom domain name (e.g., www.greenbiersportventures.com)"
      }
    },
    "enableCustomDomain": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable custom domain on routes and security policy"
      }
    }
  },
  "variables": {
    "frontDoorName": "[format('gbsv-frontdoor-{0}', parameters('environment'))]",
    "wafPolicyName": "[format('gbsvwafpolicy{0}', parameters('environment'))]",
    "endpointName": "[format('gbsv-endpoint-{0}', parameters('environment'))]",
    "originGroupDashboard": "og-dashboard",
    "originGroupOrchestrator": "og-orchestrator-api",
    "originGroupNba": "og-nba-api",
    "originGroupNcaam": "og-ncaam-api",
    "originGroupNfl": "og-nfl-api",
    "customDomainResourceName": "[replace(replace(parameters('customDomainName'), '.', '-'), '_', '-')]",
    "originGroupNcaaf": "og-ncaaf-api"
  },
  "resources": [
    {
      "condition": "[parameters('enableWaf')]",
      "type": "Microsoft.Network/FrontDoorWebApplicationFirewallPolicies",
      "apiVersion": "2024-02-01",
      "name": "[variables('wafPolicyName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('skuName')]"
      },
      "properties": {
        "policySettings": {
          "mode": "Prevention",
          "requestBodyCheck": "Enabled",
          "customBlockResponseStatusCode": 403,
          "customBlockResponseBody": "[base64('{\"error\": \"Request blocked by WAF policy\"}')]"
        },
        "managedRules": "[if(equals(parameters('skuName'), 'Premium_AzureFrontDoor'), createObject('managedRuleSets', createArray(createObject('ruleSetType', 'Microsoft_DefaultRuleSet', 'ruleSetVersion', '2.1', 'ruleSetAction', 'Block'), createObject('ruleSetType', 'Microsoft_BotManagerRuleSet', 'ruleSetVersion', '1.0', 'ruleSetAction', 'Block'))), createObject('managedRuleSets', createArray()))]",
        "customRules": {
          "rules": [
            {
              "name": "RateLimitSportEndpoints",
              "priority": 100,
              "ruleType": "RateLimitRule",
              "rateLimitDurationInMinutes": 1,
              "rateLimitThreshold": 1000,
              "matchConditions": [
                {
                  "matchVariable": "RequestUri",
                  "operator": "RegEx",
                  "matchValue": [
                    "^/(nba|ncaam|nfl|ncaaf)/"
                  ]
                }
              ],
              "action": "Block"
            },
            {
              "name": "RateLimitPredictions",
              "priority": 200,
              "ruleType": "RateLimitRule",
              "rateLimitDurationInMinutes": 1,
              "rateLimitThreshold": 100,
              "matchConditions": [
                {
                  "matchVariable": "RequestUri",
                  "operator": "RegEx",
                  "matchValue": [
                    "^/(nba|ncaam|nfl|ncaaf)/predictions"
                  ]
                }
              ],
              "action": "Block"
            },
            {
              "name": "RateLimitPicksWrite",
              "priority": 300,
              "ruleType": "RateLimitRule",
              "rateLimitDurationInMinutes": 1,
              "rateLimitThreshold": 200,
              "matchConditions": [
                {
                  "matchVariable": "RequestUri",
                  "operator": "RegEx",
                  "matchValue": [
                    "^/api/picks"
                  ]
                },
                {
                  "matchVariable": "RequestMethod",
                  "operator": "Equal",
                  "matchValue": [
                    "POST",
                    "PATCH",
                    "DELETE"
                  ]
                }
              ],
              "action": "Block"
            },
            {
              "name": "RateLimitPicksRead",
              "priority": 400,
              "ruleType": "RateLimitRule",
              "rateLimitDurationInMinutes": 1,
              "rateLimitThreshold": 500,
              "matchConditions": [
                {
                  "matchVariable": "RequestUri",
                  "operator": "RegEx",
                  "matchValue": [
                    "^/api/picks"
                  ]
                },
                {
                  "matchVariable": "RequestMethod",
                  "operator": "Equal",
                  "matchValue": [
                    "GET"
                  ]
                }
              ],
              "action": "Block"
            }
          ]
        }
      }
    },
    {
      "type": "Microsoft.Cdn/profiles",
      "apiVersion": "2024-02-01",
      "name": "[variables('frontDoorName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('skuName')]"
      },
      "properties": {
        "originResponseTimeoutSeconds": 240
      },
      "tags": {
        "environment": "[parameters('environment')]",
        "project": "gbsv-dashboard"
      }
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), variables('endpointName'))]",
      "location": "[parameters('location')]",
      "properties": {
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), variables('originGroupDashboard'))]",
      "properties": {
        "loadBalancingSettings": {
          "sampleSize": 4,
          "successfulSamplesRequired": 3,
          "additionalLatencyInMilliseconds": 50
        },
        "healthProbeSettings": {
          "probePath": "/",
          "probeRequestType": "HEAD",
          "probeProtocol": "Https",
          "probeIntervalInSeconds": 100
        },
        "sessionAffinityState": "Disabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), variables('originGroupOrchestrator'))]",
      "properties": {
        "loadBalancingSettings": {
          "sampleSize": 4,
          "successfulSamplesRequired": 3,
          "additionalLatencyInMilliseconds": 50
        },
        "healthProbeSettings": {
          "probePath": "/api/health",
          "probeRequestType": "GET",
          "probeProtocol": "Https",
          "probeIntervalInSeconds": 30
        },
        "sessionAffinityState": "Disabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), variables('originGroupNba'))]",
      "properties": {
        "loadBalancingSettings": {
          "sampleSize": 4,
          "successfulSamplesRequired": 3,
          "additionalLatencyInMilliseconds": 50
        },
        "healthProbeSettings": {
          "probePath": "/health",
          "probeRequestType": "GET",
          "probeProtocol": "Https",
          "probeIntervalInSeconds": 30
        },
        "sessionAffinityState": "Disabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), variables('originGroupNcaam'))]",
      "properties": {
        "loadBalancingSettings": {
          "sampleSize": 4,
          "successfulSamplesRequired": 3,
          "additionalLatencyInMilliseconds": 50
        },
        "healthProbeSettings": {
          "probePath": "/health",
          "probeRequestType": "GET",
          "probeProtocol": "Https",
          "probeIntervalInSeconds": 30
        },
        "sessionAffinityState": "Disabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), variables('originGroupNfl'))]",
      "properties": {
        "loadBalancingSettings": {
          "sampleSize": 4,
          "successfulSamplesRequired": 3,
          "additionalLatencyInMilliseconds": 50
        },
        "healthProbeSettings": {
          "probePath": "/health",
          "probeRequestType": "GET",
          "probeProtocol": "Https",
          "probeIntervalInSeconds": 30
        },
        "sessionAffinityState": "Disabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), variables('originGroupNcaaf'))]",
      "properties": {
        "loadBalancingSettings": {
          "sampleSize": 4,
          "successfulSamplesRequired": 3,
          "additionalLatencyInMilliseconds": 50
        },
        "healthProbeSettings": {
          "probePath": "/health",
          "probeRequestType": "GET",
          "probeProtocol": "Https",
          "probeIntervalInSeconds": 30
        },
        "sessionAffinityState": "Disabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups/origins",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('originGroupDashboard'), 'origin-dashboard')]",
      "properties": {
        "hostName": "[parameters('staticWebAppHostname')]",
        "httpPort": 80,
        "httpsPort": 443,
        "originHostHeader": "[parameters('staticWebAppHostname')]",
        "priority": 1,
        "weight": 1000,
        "enabledState": "Enabled",
        "enforceCertificateNameCheck": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupDashboard'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups/origins",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('originGroupOrchestrator'), 'origin-orchestrator-api')]",
      "properties": {
        "hostName": "[parameters('orchestratorApiHostname')]",
        "httpPort": 80,
        "httpsPort": 443,
        "originHostHeader": "[parameters('orchestratorApiHostname')]",
        "priority": 1,
        "weight": 1000,
        "enabledState": "Enabled",
        "enforceCertificateNameCheck": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupOrchestrator'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups/origins",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('originGroupNba'), 'origin-nba-api')]",
      "properties": {
        "hostName": "[parameters('nbaApiHostname')]",
        "httpPort": 80,
        "httpsPort": 443,
        "originHostHeader": "[parameters('nbaApiHostname')]",
        "priority": 1,
        "weight": 1000,
        "enabledState": "Enabled",
        "enforceCertificateNameCheck": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNba'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups/origins",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('originGroupNcaam'), 'origin-ncaam-api')]",
      "properties": {
        "hostName": "[parameters('ncaamApiHostname')]",
        "httpPort": 80,
        "httpsPort": 443,
        "originHostHeader": "[parameters('ncaamApiHostname')]",
        "priority": 1,
        "weight": 1000,
        "enabledState": "Enabled",
        "enforceCertificateNameCheck": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNcaam'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups/origins",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('originGroupNfl'), 'origin-nfl-api')]",
      "properties": {
        "hostName": "[parameters('nflApiHostname')]",
        "httpPort": 80,
        "httpsPort": 443,
        "originHostHeader": "[parameters('nflApiHostname')]",
        "priority": 1,
        "weight": 1000,
        "enabledState": "Enabled",
        "enforceCertificateNameCheck": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNfl'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/originGroups/origins",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('originGroupNcaaf'), 'origin-ncaaf-api')]",
      "properties": {
        "hostName": "[parameters('ncaafApiHostname')]",
        "httpPort": 80,
        "httpsPort": 443,
        "originHostHeader": "[parameters('ncaafApiHostname')]",
        "priority": 1,
        "weight": 1000,
        "enabledState": "Enabled",
        "enforceCertificateNameCheck": true
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNcaaf'))]"
      ]
    },
    {
      "condition": "[parameters('enableCustomDomain')]",
      "type": "Microsoft.Cdn/profiles/customDomains",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), variables('customDomainResourceName'))]",
      "properties": {
        "hostName": "[parameters('customDomainName')]",
        "tlsSettings": {
          "certificateType": "ManagedCertificate",
          "minimumTlsVersion": "TLS12"
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/ruleSets",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), 'UrlRewriteRules')]",
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/ruleSets/rules",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), 'UrlRewriteRules', 'EnforceCanonicalHost')]",
      "properties": {
        "order": 0,
        "conditions": [
          {
            "name": "RequestHeader",
            "parameters": {
              "typeName": "DeliveryRuleRequestHeaderConditionParameters",
              "selector": "Host",
              "operator": "Equal",
              "negateCondition": true,
              "matchValues": [
                "www.greenbiersportventures.com",
                "greenbiersportventures.com"
              ]
            }
          }
        ],
        "actions": [
          {
            "name": "UrlRedirect",
            "parameters": {
              "typeName": "DeliveryRuleUrlRedirectActionParameters",
              "redirectType": "Moved",
              "destinationProtocol": "Https",
              "customHostname": "www.greenbiersportventures.com"
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('endpointName'), 'route-nba')]",
      "properties": {
        "originGroup": {
          "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNba'))]"
        },
        "customDomains": "[if(parameters('enableCustomDomain'), createArray(createObject('id', resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName')))), createArray())]",
        "ruleSets": [
          {
            "id": "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
          }
        ],
        "supportedProtocols": [
          "Https"
        ],
        "patternsToMatch": [
          "/nba/*"
        ],
        "forwardingProtocol": "HttpsOnly",
        "linkToDefaultDomain": "Enabled",
        "httpsRedirect": "Enabled",
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName'))]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNba'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', variables('frontDoorName'), variables('originGroupNba'), 'origin-nba-api')]",
        "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('endpointName'), 'route-ncaam')]",
      "properties": {
        "originGroup": {
          "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNcaam'))]"
        },
        "customDomains": "[if(parameters('enableCustomDomain'), createArray(createObject('id', resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName')))), createArray())]",
        "ruleSets": [
          {
            "id": "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
          }
        ],
        "supportedProtocols": [
          "Https"
        ],
        "patternsToMatch": [
          "/ncaam/*"
        ],
        "forwardingProtocol": "HttpsOnly",
        "linkToDefaultDomain": "Enabled",
        "httpsRedirect": "Enabled",
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName'))]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNcaam'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', variables('frontDoorName'), variables('originGroupNcaam'), 'origin-ncaam-api')]",
        "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('endpointName'), 'route-nfl')]",
      "properties": {
        "originGroup": {
          "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNfl'))]"
        },
        "customDomains": "[if(parameters('enableCustomDomain'), createArray(createObject('id', resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName')))), createArray())]",
        "ruleSets": [
          {
            "id": "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
          }
        ],
        "supportedProtocols": [
          "Https"
        ],
        "patternsToMatch": [
          "/nfl/*"
        ],
        "forwardingProtocol": "HttpsOnly",
        "linkToDefaultDomain": "Enabled",
        "httpsRedirect": "Enabled",
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName'))]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNfl'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', variables('frontDoorName'), variables('originGroupNfl'), 'origin-nfl-api')]",
        "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('endpointName'), 'route-ncaaf')]",
      "properties": {
        "originGroup": {
          "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNcaaf'))]"
        },
        "customDomains": "[if(parameters('enableCustomDomain'), createArray(createObject('id', resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName')))), createArray())]",
        "ruleSets": [
          {
            "id": "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
          }
        ],
        "supportedProtocols": [
          "Https"
        ],
        "patternsToMatch": [
          "/ncaaf/*"
        ],
        "forwardingProtocol": "HttpsOnly",
        "linkToDefaultDomain": "Enabled",
        "httpsRedirect": "Enabled",
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName'))]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupNcaaf'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', variables('frontDoorName'), variables('originGroupNcaaf'), 'origin-ncaaf-api')]",
        "[resourceId('Microsoft.Cdn/profiles/ruleSets', variables('frontDoorName'), 'UrlRewriteRules')]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('endpointName'), 'route-orchestrator-api')]",
      "properties": {
        "originGroup": {
          "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupOrchestrator'))]"
        },
        "customDomains": "[if(parameters('enableCustomDomain'), createArray(createObject('id', resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName')))), createArray())]",
        "supportedProtocols": [
          "Https"
        ],
        "patternsToMatch": [
          "/api/*"
        ],
        "forwardingProtocol": "HttpsOnly",
        "linkToDefaultDomain": "Enabled",
        "httpsRedirect": "Enabled",
        "enabledState": "Enabled"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName'))]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupOrchestrator'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', variables('frontDoorName'), variables('originGroupOrchestrator'), 'origin-orchestrator-api')]"
      ]
    },
    {
      "type": "Microsoft.Cdn/profiles/afdEndpoints/routes",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}/{2}', variables('frontDoorName'), variables('endpointName'), 'route-dashboard')]",
      "properties": {
        "originGroup": {
          "id": "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupDashboard'))]"
        },
        "customDomains": "[if(parameters('enableCustomDomain'), createArray(createObject('id', resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName')))), createArray())]",
        "supportedProtocols": [
          "Https",
          "Http"
        ],
        "patternsToMatch": [
          "/*"
        ],
        "forwardingProtocol": "HttpsOnly",
        "linkToDefaultDomain": "Enabled",
        "httpsRedirect": "Enabled",
        "enabledState": "Enabled",
        "cacheConfiguration": {
          "queryStringCachingBehavior": "UseQueryString",
          "compressionSettings": {
            "isCompressionEnabled": true,
            "contentTypesToCompress": [
              "text/html",
              "text/css",
              "application/javascript",
              "application/json",
              "image/svg+xml"
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName'))]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups/origins', variables('frontDoorName'), variables('originGroupDashboard'), 'origin-dashboard')]",
        "[resourceId('Microsoft.Cdn/profiles/originGroups', variables('frontDoorName'), variables('originGroupDashboard'))]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints/routes', variables('frontDoorName'), variables('endpointName'), 'route-nba')]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints/routes', variables('frontDoorName'), variables('endpointName'), 'route-ncaaf')]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints/routes', variables('frontDoorName'), variables('endpointName'), 'route-ncaam')]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints/routes', variables('frontDoorName'), variables('endpointName'), 'route-nfl')]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints/routes', variables('frontDoorName'), variables('endpointName'), 'route-orchestrator-api')]"
      ]
    },
    {
      "condition": "[parameters('enableWaf')]",
      "type": "Microsoft.Cdn/profiles/securityPolicies",
      "apiVersion": "2024-02-01",
      "name": "[format('{0}/{1}', variables('frontDoorName'), 'waf-policy-association')]",
      "properties": {
        "parameters": {
          "type": "WebApplicationFirewall",
          "wafPolicy": {
            "id": "[resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', variables('wafPolicyName'))]"
          },
          "associations": [
            {
              "domains": "[concat(createArray(createObject('id', resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName')))), if(parameters('enableCustomDomain'), createArray(createObject('id', resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName')))), createArray()))]",
              "patternsToMatch": [
                "/*"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Cdn/profiles/customDomains', variables('frontDoorName'), variables('customDomainResourceName'))]",
        "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]",
        "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]",
        "[resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', variables('wafPolicyName'))]"
      ]
    }
  ],
  "outputs": {
    "frontDoorName": {
      "type": "string",
      "metadata": {
        "description": "Front Door profile name"
      },
      "value": "[variables('frontDoorName')]"
    },
    "frontDoorEndpointHostname": {
      "type": "string",
      "metadata": {
        "description": "Front Door endpoint hostname"
      },
      "value": "[reference(resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName')), '2024-02-01').hostName]"
    },
    "frontDoorUrl": {
      "type": "string",
      "metadata": {
        "description": "Front Door endpoint URL"
      },
      "value": "[format('https://{0}', reference(resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName')), '2024-02-01').hostName)]"
    },
    "frontDoorProfileId": {
      "type": "string",
      "metadata": {
        "description": "Front Door profile ID"
      },
      "value": "[resourceId('Microsoft.Cdn/profiles', variables('frontDoorName'))]"
    },
    "wafPolicyId": {
      "type": "string",
      "metadata": {
        "description": "WAF policy ID"
      },
      "value": "[if(parameters('enableWaf'), resourceId('Microsoft.Network/FrontDoorWebApplicationFirewallPolicies', variables('wafPolicyName')), '')]"
    },
    "endpointId": {
      "type": "string",
      "metadata": {
        "description": "Endpoint ID for custom domain association"
      },
      "value": "[resourceId('Microsoft.Cdn/profiles/afdEndpoints', variables('frontDoorName'), variables('endpointName'))]"
    }
  }
}