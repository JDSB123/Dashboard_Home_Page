name: Model Update Notification

on:
  workflow_dispatch:
    inputs:
      model_type:
        description: 'Model type (nba, nfl, ncaam, ncaaf)'
        required: true
        type: choice
        options:
          - nba
          - nfl
          - ncaam
          - ncaaf
      version:
        description: 'New model version (e.g., 2.1.0)'
        required: true
        type: string
      trigger_execution:
        description: 'Trigger immediate model execution'
        required: false
        type: boolean
        default: false
  
  # Also trigger on model repository pushes
  repository_dispatch:
    types: [model-updated]

jobs:
  notify-dashboard:
    name: Notify Dashboard of Model Update
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Extract model info from event
        id: model-info
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "model_type=${{ github.event.client_payload.model_type }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
            echo "trigger_execution=${{ github.event.client_payload.trigger_execution }}" >> $GITHUB_OUTPUT
          else
            echo "model_type=${{ github.event.inputs.model_type }}" >> $GITHUB_OUTPUT
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "trigger_execution=${{ github.event.inputs.trigger_execution }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Get Model Container App FQDN
        id: get-fqdn
        run: |
          MODEL_TYPE="${{ steps.model-info.outputs.model_type }}"
          
          # Map model type to RG and app names
          case "$MODEL_TYPE" in
            nba)
              RG_NAME="nba-gbsv-model-rg"
              APP_NAME="nba-gbsv-api"
              ;;
            ncaam)
              RG_NAME="ncaam-gbsv-model-rg"
              APP_NAME="ncaam-stable-prediction"
              ;;
            nfl)
              RG_NAME="nfl-gbsv-model-rg"
              APP_NAME="nfl-api"
              ;;
            ncaaf)
              RG_NAME="ncaaf-gbsv-model-rg"
              APP_NAME="ncaaf-v5-prod"
              ;;
            *)
              echo "Unknown model type: $MODEL_TYPE"
              exit 1
              ;;
          esac
          
          echo "Model: $MODEL_TYPE"
          echo "RG: $RG_NAME"
          echo "App: $APP_NAME"
          
          # Get the container app FQDN
          FQDN=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RG_NAME" \
            --query 'properties.configuration.ingress.fqdn' \
            --output tsv 2>/dev/null)
          
          if [ -z "$FQDN" ]; then
            echo "⚠️  Could not fetch FQDN from container app (may not exist yet)"
            # Use endpoint from environment variable as fallback
            case "$MODEL_TYPE" in
              nba)
                FQDN="nba-gbsv-api.livelycoast-b48c3cb0.eastus.azurecontainerapps.io"
                ;;
              ncaam)
                FQDN="ncaam-stable-prediction.blackglacier-5fab3573.centralus.azurecontainerapps.io"
                ;;
              nfl)
                FQDN="nfl-api.purplegrass-5889a981.eastus.azurecontainerapps.io"
                ;;
              ncaaf)
                FQDN="ncaaf-v5-prod.salmonwave-314d4ffe.eastus.azurecontainerapps.io"
                ;;
            esac
          fi
          
          ENDPOINT="https://$FQDN"
          echo "Endpoint: $ENDPOINT"
          echo "fqdn=$ENDPOINT" >> $GITHUB_OUTPUT

      - name: Update Model Registry
        env:
          ORCHESTRATOR_URL: ${{ secrets.ORCHESTRATOR_URL }}
          ORCHESTRATOR_KEY: ${{ secrets.ORCHESTRATOR_KEY }}
        run: |
          MODEL_TYPE="${{ steps.model-info.outputs.model_type }}"
          VERSION="${{ steps.model-info.outputs.version }}"
          ENDPOINT="${{ steps.get-fqdn.outputs.fqdn }}"
          
          echo "Updating model registry:"
          echo "  Model: $MODEL_TYPE"
          echo "  Version: $VERSION"
          echo "  Endpoint: $ENDPOINT"
          
          response=$(curl -X POST \
            "$ORCHESTRATOR_URL/registry/update" \
            -H "Content-Type: application/json" \
            -H "x-functions-key: $ORCHESTRATOR_KEY" \
            -d '{
              "model": "'$MODEL_TYPE'", 
              "version": "'$VERSION'",
              "endpoint": "'$ENDPOINT'",
              "timestamp": "'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"
            }' \
            -w "\n%{http_code}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" != "200" ]; then
            echo "Failed to update registry. HTTP $http_code"
            echo "$body"
            exit 1
          fi
          
          echo "✅ Registry updated successfully"
      
      - name: Invalidate Dashboard Cache
        env:
          ORCHESTRATOR_URL: ${{ secrets.ORCHESTRATOR_URL }}
          ORCHESTRATOR_KEY: ${{ secrets.ORCHESTRATOR_KEY }}
        run: |
          echo "Invalidating cache for ${{ steps.model-info.outputs.model_type }}"
          
          curl -X POST \
            "$ORCHESTRATOR_URL/cache/invalidate" \
            -H "Content-Type: application/json" \
            -H "x-functions-key: $ORCHESTRATOR_KEY" \
            -d '{
              "model": "${{ steps.model-info.outputs.model_type }}"
            }' || true
      
      - name: Trigger Model Execution
        if: steps.model-info.outputs.trigger_execution == 'true'
        env:
          ORCHESTRATOR_URL: ${{ secrets.ORCHESTRATOR_URL }}
          ORCHESTRATOR_KEY: ${{ secrets.ORCHESTRATOR_KEY }}
        run: |
          echo "Triggering execution for ${{ steps.model-info.outputs.model_type }}"
          
          response=$(curl -X POST \
            "$ORCHESTRATOR_URL/execute" \
            -H "Content-Type: application/json" \
            -H "x-functions-key: $ORCHESTRATOR_KEY" \
            -d '{
              "model": "${{ steps.model-info.outputs.model_type }}", 
              "params": {
                "date": "today",
                "source": "ci-cd-update",
                "version": "${{ steps.model-info.outputs.version }}"
              }
            }' \
            -w "\n%{http_code}")
          
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          
          if [ "$http_code" == "202" ]; then
            jobId=$(echo "$body" | jq -r '.jobId')
            echo "Model execution started. Job ID: $jobId"
            echo "job_id=$jobId" >> $GITHUB_OUTPUT
          else
            echo "Failed to trigger execution. HTTP $http_code"
            echo "$body"
          fi
      
      - name: Create deployment record
        uses: actions/github-script@v7
        with:
          script: |
            const model = '${{ steps.model-info.outputs.model_type }}';
            const version = '${{ steps.model-info.outputs.version }}';
            const triggered = '${{ steps.model-info.outputs.trigger_execution }}' === 'true';
            
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              task: `deploy-model-${model}`,
              auto_merge: false,
              required_contexts: [],
              payload: {
                model_type: model,
                version: version,
                execution_triggered: triggered
              },
              environment: `${model}-model`,
              description: `Model ${model} updated to v${version}`
            });
            
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment.data.id,
              state: 'success',
              environment_url: `${{ secrets.DASHBOARD_URL }}`,
              description: `Model ${model} v${version} deployed`
            });
      
      - name: Send notification to Teams/Slack
        if: success()
        env:
          WEBHOOK_URL: ${{ secrets.NOTIFICATION_WEBHOOK_URL }}
        run: |
          if [ -n "$WEBHOOK_URL" ]; then
            curl -X POST "$WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "text": "Model Update Notification",
                "attachments": [{
                  "color": "good",
                  "fields": [
                    {
                      "title": "Model",
                      "value": "${{ steps.model-info.outputs.model_type }}",
                      "short": true
                    },
                    {
                      "title": "Version",
                      "value": "${{ steps.model-info.outputs.version }}",
                      "short": true
                    },
                    {
                      "title": "Status",
                      "value": "Registry Updated",
                      "short": true
                    },
                    {
                      "title": "Execution",
                      "value": "${{ steps.model-info.outputs.trigger_execution == 'true' && 'Triggered' || 'Not Triggered' }}",
                      "short": true
                    }
                  ],
                  "footer": "GitHub Actions",
                  "ts": '$(date +%s)'
                }]
              }' || true
          fi

  # Job to update model endpoints if Container App URLs change
  update-endpoints:
    name: Update Model Endpoints
    runs-on: ubuntu-latest
    if: github.event_name == 'repository_dispatch' && github.event.action == 'endpoint-updated'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Update config.production.js
        run: |
          model_type="${{ github.event.client_payload.model_type }}"
          new_endpoint="${{ github.event.client_payload.endpoint }}"
          
          case "$model_type" in
            nba)
              sed -i "s|NBA_API_URL: '.*'|NBA_API_URL: '$new_endpoint'|" config.production.js
              ;;
            nfl)
              sed -i "s|NFL_API_URL: '.*'|NFL_API_URL: '$new_endpoint'|" config.production.js
              ;;
            ncaam)
              sed -i "s|NCAAM_API_URL: '.*'|NCAAM_API_URL: '$new_endpoint'|" config.production.js
              ;;
            ncaaf)
              sed -i "s|NCAAF_API_URL: '.*'|NCAAF_API_URL: '$new_endpoint'|" config.production.js
              ;;
          esac
      
      - name: Commit and push changes
        if: github.event.client_payload.auto_commit == true
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          git add config.production.js
          git diff --staged --quiet || git commit -m "Update ${{ github.event.client_payload.model_type }} endpoint to ${{ github.event.client_payload.endpoint }}"
          git push
