name: Deploy Azure Front Door Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      skip_waf:
        description: 'Skip WAF policy deployment'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Dry run (what-if mode)'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write   # Required for azure/login OIDC federated credentials
  contents: read    # Required to checkout the repository

env:
  RESOURCE_GROUP: dashboard-gbsv-main-rg
  LOCATION: eastus

jobs:
  validate:
    name: Validate Bicep Templates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Bicep
        run: |
          az bicep build --file infra/main.bicep
          echo "âœ… Bicep validation passed"

  deploy:
    name: Deploy Front Door
    needs: validate
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    outputs:
      frontDoorHostname: ${{ steps.deploy.outputs.frontDoorHostname }}
      frontDoorUrl: ${{ steps.deploy.outputs.frontDoorUrl }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Resource Group Exists
        run: |
          if [ "$(az group exists --name ${{ env.RESOURCE_GROUP }})" = "false" ]; then
            echo "Creating resource group..."
            az group create --name ${{ env.RESOURCE_GROUP }} --location ${{ env.LOCATION }}
          fi

      - name: Deploy Front Door (What-If)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          az deployment group what-if \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters infra/main.bicepparam \
            --parameters environment=${{ github.event.inputs.environment }} \
            --parameters enableWaf=${{ github.event.inputs.skip_waf != 'true' }}

      - name: Deploy Front Door
        id: deploy
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          DEPLOYMENT_NAME="frontdoor-${{ github.event.inputs.environment }}-$(date +%Y%m%d-%H%M%S)"
          
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name $DEPLOYMENT_NAME \
            --template-file infra/main.bicep \
            --parameters infra/main.bicepparam \
            --parameters environment=${{ github.event.inputs.environment }} \
            --parameters enableWaf=${{ github.event.inputs.skip_waf != 'true' }}
          
          # Get outputs
          HOSTNAME=$(az deployment group show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.frontDoorEndpointHostname.value -o tsv)
          
          URL=$(az deployment group show \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name $DEPLOYMENT_NAME \
            --query properties.outputs.frontDoorUrl.value -o tsv)
          
          echo "frontDoorHostname=$HOSTNAME" >> $GITHUB_OUTPUT
          echo "frontDoorUrl=$URL" >> $GITHUB_OUTPUT
          
          echo "## ðŸŽ‰ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint Hostname | \`$HOSTNAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint URL | $URL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure custom domain DNS to point to \`$HOSTNAME\`" >> $GITHUB_STEP_SUMMARY
          echo "2. Add custom domain to Front Door" >> $GITHUB_STEP_SUMMARY
          echo "3. Update \`client/config.js\` with the new endpoint URL" >> $GITHUB_STEP_SUMMARY

  test-endpoints:
    name: Test Front Door Endpoints
    needs: deploy
    if: ${{ github.event.inputs.dry_run != 'true' }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for propagation
        run: sleep 60

      - name: Test Front Door Endpoint
        run: |
          ENDPOINT="https://${{ needs.deploy.outputs.frontDoorHostname }}"
          
          echo "Testing Front Door endpoint: $ENDPOINT"
          
          # Test root (dashboard)
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$ENDPOINT/")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… Dashboard route: OK ($STATUS)"
          else
            echo "âš ï¸ Dashboard route: $STATUS"
          fi
          
          # Test API health
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$ENDPOINT/api/health")
          if [ "$STATUS" = "200" ]; then
            echo "âœ… API health route: OK ($STATUS)"
          else
            echo "âš ï¸ API health route: $STATUS (may need origin to be healthy)"
          fi

  notify:
    name: Notify Deployment
    needs: [deploy, test-endpoints]
    if: ${{ github.event.inputs.dry_run != 'true' && always() }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Create Summary
        run: |
          echo "## Azure Front Door Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Endpoint:** ${{ needs.deploy.outputs.frontDoorUrl }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Routing Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Path | Backend |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| \`/*\` | Static Web App (Dashboard) |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/api/*\` | Orchestrator Container App |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/api/nba/*\` | NBA API Container App |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/api/ncaam/*\` | NCAAM API Container App |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/api/nfl/*\` | NFL API Container App |" >> $GITHUB_STEP_SUMMARY
          echo "| \`/api/ncaaf/*\` | NCAAF API Container App |" >> $GITHUB_STEP_SUMMARY
